<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Storage Server</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
    <link rel="icon" type="image/png" href="P2PStorageFavicon_0.png">
</head>

<style>
    :root {
        --backgroundColour: #131626;
        --mainColour:#4d4d80;
        --accentColour: #e6a1cf;
        
        /*Log colours*/
        --infoColour: #498f45;
        --warningColour : #f6ec60;
        --errorColour : #cc1212;
    }
    *{
        margin:0;
        padding: 0;
        font-family: "Roboto Mono", serif; /*font to use*/
    }
    
    .displayText{
        color : var(--mainColour);
    }

    .header {
        margin: auto;
        width: 100%;
        padding: 10px;
        min-height: 100px;
        text-align: center;
        /*position: absolute; */
        top:0;
        margin-bottom: 30px;
    }
    
    .header h1{
        margin: auto;
        width: 70%;
        padding: 10px;
        text-align: center;
        color:var(--accentColour);
        font-size: 60px;
        border: 3px solid var(--accentColour);
        border-radius: 20px;
        /*background-color: #2a173b;*/
    }
    
    body {
        display: flex;
        justify-content: center;
        align-items: center;
        /*height: 100vh; */
        width: 100%;
        margin: 0;
        flex-direction: column;
        overflow-y: auto;
        background-color: var(--backgroundColour); 
    }
    
    .infoAndLogContainer {
        display: flex;
        align-items: stretch; /* makes both sides the same height */
        justify-content: center;
        gap: 80px;
        margin-bottom: 30px;
    }
    

    .serverInformation {
        padding: 10px 30px;
        color : var(--mainColour);
        border: 3px solid var(--mainColour);
        border-radius: 20px;
        margin-bottom: 20px;
    }

    .status {
        display: flex;
        text-align: center;
        align-items: center; /* vertically center */
        gap: 40px; /* spacing between h2 and p */
    }
      
    .number {
        color: var(--accentColour);      
    }
      
    .serverInformationNumber {
        margin: 0; 
        width : 40px;
        text-align: left
    }

    .descriptor{
        margin: 0;
    }

    .bold{
        font-weight: 900;
    }

    .shutdownButton{
        border : 3px solid var(--mainColour);
        border-radius: 20px;
        padding : 5px;
        cursor: pointer;
        margin-top: 20px;
    }

    #shutdownBtn {
        font-size: 24px;
        padding: 10px 30px;
        background-color: var(--backgroundColour);
        border: none;
        border-radius: 10px;
        color: var(--mainColour);
        font-size : 30px;
        cursor: pointer;
        transition: 0.2s;
    }
    
    .shutdownButton:hover {
        border-color: var(--accentColour);
    } 

    #shutdownBtn:hover {
        border-color: var(--accentColour);
        font-size: 35px;
        color:var(--accentColour);
    }

    #serverLogUL {
        flex-grow: 1;
        list-style-type: none;
        overflow-y: auto;
        border: 3px solid var(--mainColour);
        border-radius: 20px;
        padding: 0;
        margin: 0;
        max-height: 410px;
    }

    .serverLog {
        display: flex;
        flex-direction: column;
        flex: 1; /* optional: makes it grow if needed */
        min-height: 100%; /* ensure it stretches */
    }

    .serverLogEntry {
        margin-top: 5px;
        margin-left: 5px;
        margin-right: 5px;
        border-radius: 20px;
        margin-bottom: 5px;
        cursor: pointer;
        transition: 0.2s;
        padding: 3px 5px;
        border: 2px solid var(--infoColour);
        
    }
    
    .error{
        color : var(--errorColour);
        border-color: var(--errorColour);
    }

    .info{
        color : var(--infoColour);
        border-color: var(--infoColour);
    }

    .warning{
        color: var(--warningColour);
        border-color: var(--warningColour);
    }

    .serverLogEntry:hover{
        font-size: 18px;
    }

    .serverEntryOutline {
        margin-top: 16px;
        border: 3px solid var(--mainColour);
        border-radius: 20px;
        padding: 5px 5px;
    }

    .serverEntryOutlineType {
        text-decoration: underline;
    }

    #dataChart {
        background-color: var(--backgroundColour);
        border : 3px solid var(--mainColour);
        border-radius: 20px;
    }

    .displayButton {
        border-radius: 20px;
        margin: 5px 20px;
        width: 90px;
        cursor : pointer;
        transition: 0.2s;
        padding: 5px 0px;
        background-color: var(--backgroundColour); 
    }

    .dataGraphButton {
        color: var(--accentColour);
        border : 3px solid var(--accentColour);
    }

    .dataGraphHeader {
        width : 400px;
        text-align: center;
        border : 3px solid var(--accentColour);
        color: var(--accentColour);
        border-radius: 20px;
        margin-bottom: 5px;
    }

    .ipPortValueDisplay {
        display: flex;
        text-align: center;
        align-items: center; /* vertically center */
    } 

    .IPPortSettings{
        justify-content: center;
        border : 3px solid var(--mainColour);
        padding: 5px 5px;
        margin-bottom: 10px;
        border-radius: 20px;
        align-content: center;
    }

    .IPDisplay {
        gap: 40px;
    }

    .portDisplay {
        gap: 10px;
    }

    #settingsDisplayText {
        justify-content: center;
        text-align: center;
        width: 600px;
        border: 3px solid var(--accentColour);
        color: var(--accentColour);
        border-radius: 20px;
        margin-bottom: 10px;
        font-size: 40px;
    }

    #loggingLevel { 
        border: 3px solid var(--mainColour);
        border-radius: 20px;
        padding: 5px;
        margin-bottom: 10px;
        text-align: center;
    }

    #loggingLevelDisplayContainer {
        display: flex;
        text-align: center;
        align-items: center; /* vertically center */
        gap : 20px;
    }

    .loggingLevelButton {
        border: 3px solid;
    }

    .underlineFade::after {
        content: "";
        display: block;
        height: 2px;
        background-color: currentColor;
        transform: scaleX(0);
        transform-origin: left;
        opacity: 0;
        transition: transform 0.3s ease, opacity 0.3s ease;
    }
      
    .underlineFade:hover::after {
    transform: scaleX(1);
    opacity: 1;
    }

    .colourButton {
        border : 3px solid var(--accentColour);
        border-radius: 20px;
        color: var(--accentColour);
    }

    #colourSchemeOptions {
        border : 3px solid var(--mainColour);
        border-radius: 20px;
        padding: 5px;
        text-align: center;
    }

    .IPPortSettings{
        text-align: center;
    }

</style>

<body>
    <section class="header">
        <h1 class="displayText">P2P Storage Server</h1>
    </section>


    <section class="infoAndLogContainer">
        <div class="serverLog">
            <ul id="serverLogUL">
            </ul>
            <div class="serverEntryOutline">
                <h2 class="displayText error serverEntryOutlineType">Error - 21:40:13-03:05:2025</h2><p class="displayText error">Not enough codes available</p>
            </div>
        </div>

        <div id="serverInfoAndGraphContainer">
            <div class="serverInformation">
                <div class="status">
                    <h2 class="number serverInformationNumber" id="PeersConnected">50000</h2>
                    <h2 class = "descriptor displayText">Peers Connected</h2>
                </div>
                <div class="status">
                    <h2 class="number serverInformationNumber" id = "FilesInStorage">12</h2>
                    <h2 class = "descriptor displayText">Files In Storage</h2>
                </div>
                <div class="status">
                    <h2 class="number serverInformationNumber" id = "FilesToDelete">15</h2>
                    <h2 class = "descriptor displayText">Files To Delete</h2>
                </div>
                <div class="status">
                    <h2 class="number serverInformationNumber" id = "FilesToReturn">4</h2>
                    <h2 class = "descriptor displayText">Files To Return</h2>
                </div>
            </div>
            <div class="dataGraph">
                <h2 class="displayText dataGraphHeader">Peers Graph</h2>
                <canvas id="dataChart" width="400" height="250"></canvas>
                <div class="dataGraphButtons">
                    <button id="24hButton" class="displayText dataGraphButton displayButton bold underlineFade">24 Hours</button>
                    <button id="7dButton" class="displayText dataGraphButton displayButton bold underlineFade">7 Days</button>
                    <button id="30dButton" class="displayText dataGraphButton displayButton bold underlineFade">30 Days</button>
                </div>
            </div>
        </div>
    </section>

    <section class="settings">
        <h1 class="displayText" id="settingsDisplayText">Settings</h1>
        <div class="IPPortSettings">
            <div class="ipPortValueDisplay IPDisplay">
                <h2 class="displayText ">IP</h2>
                <h2 class = "valueDisplay number" id="IPDisplay">32.24.134.15</h2>
            </div>
            <div class="ipPortValueDisplay portDisplay">
                <h2 class="displayText">Port</h2>
                <h2 class = "valueDisplay number" id = "portDisplay">12345</h2>
            </div>
        </div>
        <div id="loggingLevel">
            <div id = "loggingLevelDisplayContainer">
                <h2 id="loggingLevelDisplayLabel" class="displayText">Current Log Level : </h2>
                <h2 class = "displayText error" id = "loggingLevelDisplay">Error</h2>
            </div>
            <div id="loggingLevelButtons">
                <button id="loggingLevelButtonInfo" class="displayText displayButton loggingLevelButton bold info underlineFade">INFO</button>
                <button id="loggingLevelButtonWarning" class="displayText displayButton loggingLevelButton bold warning underlineFade">WARNING</button>
                <button id="loggingLevelButtonError" class="displayText displayButton loggingLevelButton bold error underlineFade">ERROR</button>
            </div>
        </div>
        <div id="colourSchemeOptions">
            <h2 class="displayText ">Colour Palette Options</h2>
            <div id="colourButtons">
                <div id="colourButtonsRow1" class="colourButtonsRow">
                    <button id="colourButtonGreen" class="displayText displayButton colourButton bold underlineFade" data-color="Green">Green</button>
                    <button id="colourButtonBlue" class="displayText displayButton colourButton bold underlineFade" data-color="Blue">Blue</button>
                    <button id="colourButtonRed" class="displayText displayButton colourButton bold underlineFade" data-color="Red">Red</button>
                    <button id="colourButtonGold" class="displayText displayButton colourButton bold underlineFade" data-color="Gold">Gold</button>
                </div>
                <div id="colourButtonsRow2" class="colourButtonsRow">
                    <button id="colourButtonMonochrome" class="displayText displayButton colourButton bold underlineFade" data-color="Monochrome">Monochrome</button>
                    <button id="colourButtonPink" class="displayText displayButton colourButton bold underlineFade" data-color="Pink">Pink</button>
                    <button id="colourButtonMidnight" class="displayText displayButton colourButton bold underlineFade" data-color="Midnight">Midnight</button>
                    <button id="colourButtonSilver" class="displayText displayButton colourButton bold underlineFade" data-color="Silver">Silver</button>
                </div>
            </div>
        </div>
    </section>

    <div class="shutdownButton">
        <button id="shutdownBtn" class="displayText underlineFade">SHUT DOWN SERVER</button>
    </div>

    <script>
        var preferencesData = null;
        var themeData = null;
        var currentColours = null;
        var logLevel = null;
        var log = null
        var serverData = null;
        var dataChart = null;

        async function loadPreferences() {
            try {
                const response = await fetch('Preferences.json');
                if (!response.ok) throw new Error("Network response was not OK");
                const data = await response.json();
                console.log("1. Data loaded:", data);
        
                // Code here waits for fetch to finish
                preferencesData = data;
                // Any code here will run after fetch is done
            } catch (error) {
                console.error("Fetch error:", error);
            }
        }

        async function loadThemes() {
            try {
                const response = await fetch('Themes.json');
                if (!response.ok) throw new Error("Network response was not OK");
                const data = await response.json();
                console.log("2. Data loaded:", data);
        
                // Code here waits for fetch to finish
                themeData = data;
                
                // Any code here will run after fetch is done
            } catch (error) {
                console.error("Fetch error:", error);
            }
        }

        async function LoadLog() {
            try {
                const response = await fetch('Test.log');
                if (!response.ok) throw new Error("Network response was not OK");
                const data = await response.text();
                // Code here waits for fetch to finish
                log = data;
                
                // Any code here will run after fetch is done
            } catch (error) {
                console.error("Fetch error:", error);
            }
        }

        async function loadServerData() {
            try {
                const response = await fetch('ServerData.json');
                if (!response.ok) throw new Error("Network response was not OK");
                const data = await response.json();
                console.log("3. Data loaded:", data);
        
                // Code here waits for fetch to finish
                serverData = data;
                
                // Any code here will run after fetch is done
            } catch (error) {
                console.error("Fetch error:", error);
            }
        }

        function DrawGraph() {
            const ctx = document.getElementById('dataChart').getContext('2d');
            
            // If a chart instance already exists, destroy it before creating a new one
            if (dataChart) {
                dataChart.destroy();
            }
        
            // Define your chart data and configuration
            const customLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const lineColour = getComputedStyle(document.documentElement).getPropertyValue('--accentColour').trim();
        
            // Create new chart
            dataChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: customLabels,
                    datasets: [{
                        label: 'Peers',
                        data: Array.from({ length: 7 }, () => Math.floor(Math.random() * 201)),
                        borderColor: lineColour,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false
                }
            });
        }

        async function Init() {
            //Setting colours
            await loadPreferences();
            await loadThemes();
            await LoadLog();
            await loadServerData();

            currentColours = themeData[preferencesData.Theme];
            logLevel = preferencesData.LogLevel;

            console.log(`${currentColours.background} ${currentColours.main} ${currentColours.accent}`);

            document.documentElement.style.setProperty('--backgroundColour', currentColours.background);
            document.documentElement.style.setProperty('--mainColour', currentColours.main);
            document.documentElement.style.setProperty('--accentColour', currentColours.accent);

            //Setting Log Level Display
            document.getElementById("loggingLevelDisplay").className = `displayText ${logLevel.charAt(0).toLowerCase() + logLevel.slice(1)}`;
            document.getElementById("loggingLevelDisplay").textContent = logLevel;

            //Setting logs
            console.log(typeof(log));
            console.log(log);
            log = log.split("\n");
            let ulElement = document.getElementById('serverLogUL');
            for(let logEntry of log){
                logEntry = logEntry.split(" - ");
                //Writing to the display
                let newLi = document.createElement('li');
                newLi.textContent = `${logEntry[0]} - ${logEntry[1]}`;  // Set the text of the new list item 
                newLi.className = `${logEntry[1].toLowerCase()} bold displayText serverLogEntry underlineFade`;
                ulElement.appendChild(newLi);
            } 

            //Setting Server Data
            document.getElementById("PeersConnected").textContent = serverData["Peers Connected"];
            document.getElementById("FilesInStorage").textContent = serverData["Files In Storage"];
            document.getElementById("FilesToDelete").textContent = serverData["Files To Delete"];
            document.getElementById("FilesToReturn").textContent = serverData["Files To Return"];
            
            DrawGraph();
        }

        Init();

        //Setting up colour buttons
        const buttons = document.querySelectorAll('.colourButton');
        buttons.forEach(button => {
            button.addEventListener('click', () => {
                let colour = button.getAttribute('data-color');
                
                console.log(`Selected colour: ${colour}`);
                
                let theme = themeData[colour];

                document.documentElement.style.setProperty('--backgroundColour', theme.background);
                document.documentElement.style.setProperty('--mainColour', theme.main);
                document.documentElement.style.setProperty('--accentColour', theme.accent);
            
                DrawGraph();
            });
        });

    </script>

</body>
</html>
